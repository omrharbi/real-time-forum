<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #log {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            height: 200px;
            overflow-y: auto;
            background: #f9f9f9;
        }

        input {
            width: 80%;
            padding: 10px;
        }

        button {
            padding: 10px;
        }

        .connec {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: #ffffff;
            width: 300px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .connec h2 {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 10px;
        }

        .user-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            padding: 18px;
            border-bottom: 1px solid #eee;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #555;
            margin-right: 10px;
        }

        .user-name {
            font-size: 1rem;
            color: #333;
        }

        .status {
            margin-left: auto;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <h1>WebSocket Test</h1>
    <div class="connec">
        <h2>Connected Users</h2>
        <ul class="user-list" id="userList">
            <!-- User items will be added dynamically -->
        </ul>
    </div>
    <div>
        <input type="text" id="messageInput" placeholder="Type your message here..." />
        <button id="sendButton">Send</button>
    </div>
    <div id="log"></div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const ws = new WebSocket("ws://localhost:8080/ws");
            const userList = document.getElementById("userList");
            const log = document.getElementById("log");
            const messageInput = document.getElementById("messageInput");
            const sendButton = document.getElementById("sendButton");

            const cookies = document.cookie.split("token=")[1];
            const storedData = localStorage.getItem("data");
            const parsedData = JSON.parse(storedData);
            const receiver = new URLSearchParams(window.location.search).get("receiver");

            ws.onopen = () => {
                console.log("WebSocket connected.");
                ws.send(
                    JSON.stringify({
                        type: "status",
                        content: "online",
                    })
                );
                fetchConnectedUsers();
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);

                switch (message.type) {
                    case "online_list":
                        console.log();
                        updateUserList(message.online_users);
                        break;
                    case "message":
                        displayMessage(message.sender, message.content);
                        break;
                    case "typing":
                        showTypingNotification(message.userId);
                        break;
                    default:
                        console.warn("Unhandled message type:", message.type);
                }
            };

            ws.onclose = () => {
                console.log("WebSocket connection closed.");
                logMessage("WebSocket disconnected.");
            };

            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
            };

            sendButton.addEventListener("click", () => {
                const message = messageInput.value.trim();
                if (message) {
                    ws.send(
                        JSON.stringify({
                            type: "message",
                            content: message,
                            sender: parsedData.id,
                            receiver: +receiver,
                        })
                    );
                    messageInput.value = "";
                    displayMessage(parsedData.id, message, true);
                }
            });

            async function fetchConnectedUsers() {
                const response = await fetch("/api/connected");
                if (response.ok) {
                    const users = await response.json();
                    updateUserList(users);
                }
            }

            function updateUserList(users) {
                 users.forEach((user) => {
                    addUser(user.id, user.username, user.status);
                });
            }

            function addUser(userId, userName, status) {
                const userItem = document.createElement("li");
                userItem.className = "user-item";
                userItem.setAttribute("data-id", userId);

                const userIcon = document.createElement("div");
                userIcon.className = "user-icon";
                userIcon.textContent = userName[0].toUpperCase();

                const userNameDiv = document.createElement("div");
                userNameDiv.className = "user-name";
                userNameDiv.textContent = userName;

                const statusDot = document.createElement("span");
                statusDot.className = "status";
                statusDot.style.background = status === "online" ? "green" : "red";

                userItem.append(userIcon, userNameDiv, statusDot);

                userItem.addEventListener("click", () => {
                    window.history.pushState({}, "", `messages?receiver=${userId}`);
                });

                userList.appendChild(userItem);
            }

            function displayMessage(sender, content, isOwnMessage = false) {
                const messageDiv = document.createElement("div");
                messageDiv.textContent = `${isOwnMessage ? "You" : sender}: ${content}`;
                log.appendChild(messageDiv);
                log.scrollTop = log.scrollHeight;
            }

            function logMessage(message) {
                const logDiv = document.createElement("div");
                logDiv.textContent = message;
                log.appendChild(logDiv);
                log.scrollTop = log.scrollHeight;
            }

            function showTypingNotification(userId) {
                logMessage(`User ${userId} is typing...`);
                setTimeout(() => {
                    logMessage("");
                }, 3000);
            }
        });


    </script>
</body>

</html>